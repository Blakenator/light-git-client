<app-modal [modalId]="'addWorktree'+uidSalt"
  modalTitle="Add Worktree"
  modalTitleIcon="fa-copy"
  affirmativeButtonText="Add"
  modalClass="dialog-wide"
  [affirmativeButtonDisabled]="isLoading"
  [negativeButtonText]="isLoading?'Close':'Cancel'"
  (onCancel)="cancel()"
  (onFinish)="add()"
  [leaveOpen]="true">
  @if (!selectedBranch) {
    <div class="form-group">
      <label>Choose Branch</label>
      <input class="form-control"
        [(ngModel)]="filter"
        placeholder="Branch filter...">
      @if (branchError) {
        <small class="error-message">{{branchError}}</small>
      }
      <div class="branch-list">
        <table class="table table-striped table-hover">
          @for (b of branches | filterObject : 'name' : filter; track b) {
            <tr>
              <td>{{b.name}}</td>
              <td>
                <button class="btn btn-primary" (click)="chooseBranch(b)" [disabled]="branchLockedOtherWorktree(b)">Select
                </button>
                @if (branchLockedOtherWorktree(b); as lock) {
                  <span class="fa fa-lock ml-2"
                  [ngbTooltip]="'Branch already checked out in worktree \''+lock.name+'\''"></span>
                }
              </td>
            </tr>
          }
        </table>
      </div>
    </div>
  }
  @if (selectedBranch) {
    <div>
      Selected Branch:
      <span class="badge badge-primary p-2 selected-branch" (click)="selectedBranch=undefined">
        {{selectedBranch.name}}
        <i class="fa fa-times"></i>
      </span>
    </div>
  }
  <app-file-input [allowMultiple]="false"
    [isFolder]="true"
    label="Worktree Location"
    [(filePath)]="path"
  [disabled]="isLoading"></app-file-input>
  @if (pathError) {
    <small class="error-message">{{pathError}}</small>
  }
  <div class="card">
    <div class="card-header">Output
      <app-loading-spinner class="d-inline-block" [show]="isLoading"></app-loading-spinner>
    </div>
    <div class="card-body">
      @for (o of output; track o) {
        <div>
          @if (o.err) {
            <pre style="color:rgba(250,150,150,.5)">{{o.err}}</pre>
          }
          @if (o.out) {
            <pre>{{o.out}}</pre>
          }
          @if (o.done) {
            <pre class="text-muted">command execution finished -------------</pre>
          }
        </div>
      }
    </div>
  </div>
</app-modal>
